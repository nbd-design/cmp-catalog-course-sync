name: Daily Course Sync

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual triggering from Actions tab
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run sync script
        id: sync
        continue-on-error: true
        env:
          HUBSPOT_PRIVATE_APP_TOKEN: ${{ secrets.HUBSPOT_PRIVATE_APP_TOKEN }}
        run: |
          npm run sync 2>&1 | tee sync-output.log
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Extract sync summary
        id: summary
        if: always()
        run: |
          if [ -f sync-output.log ]; then
            # Extract key metrics from the log
            API_COURSES=$(grep -oP "(?<=API courses: )\d+" sync-output.log || echo "N/A")
            HUBDB_BEFORE=$(grep -oP "(?<=HubDB before sync: )\d+" sync-output.log || echo "N/A")
            HUBDB_AFTER=$(grep -oP "(?<=HubDB after sync: )\d+" sync-output.log || echo "N/A")
            CREATED=$(grep -oP "(?<=Created: )\d+" sync-output.log || echo "N/A")
            UPDATED=$(grep -oP "(?<=Updated: )\d+" sync-output.log || echo "N/A")
            DELETED=$(grep -oP "(?<=Deleted: )\d+" sync-output.log || echo "N/A")
            FAILED=$(grep -oP "(?<=Failed: )\d+" sync-output.log || echo "N/A")
            SUCCESS_RATE=$(grep -oP "(?<=Success rate: )[0-9.]+%" sync-output.log || echo "N/A")
            DURATION=$(grep -oP "(?<=Duration: )[0-9.]+s" sync-output.log || echo "N/A")
            
            echo "api_courses=$API_COURSES" >> $GITHUB_OUTPUT
            echo "hubdb_before=$HUBDB_BEFORE" >> $GITHUB_OUTPUT
            echo "hubdb_after=$HUBDB_AFTER" >> $GITHUB_OUTPUT
            echo "created=$CREATED" >> $GITHUB_OUTPUT
            echo "updated=$UPDATED" >> $GITHUB_OUTPUT
            echo "deleted=$DELETED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
            echo "duration=$DURATION" >> $GITHUB_OUTPUT
          fi

      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT || 587 }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.sync.outputs.exit_code == '0' && 'âœ… HubSpot Course Sync - Success' || 'âŒ HubSpot Course Sync - Failed' }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.SMTP_FROM || secrets.SMTP_USERNAME }}
          body: |
            HubSpot Course Sync Report
            ==========================================
            
            Status: ${{ steps.sync.outputs.exit_code == '0' && 'âœ… SUCCESS' || 'âŒ FAILED' }}
            Date: ${{ github.event.repository.updated_at }}
            Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Sync Results:
            - API Courses: ${{ steps.summary.outputs.api_courses }}
            - HubDB Before: ${{ steps.summary.outputs.hubdb_before }}
            - HubDB After: ${{ steps.summary.outputs.hubdb_after }}
            
            Operations:
            - Created: ${{ steps.summary.outputs.created }}
            - Updated: ${{ steps.summary.outputs.updated }}
            - Deleted: ${{ steps.summary.outputs.deleted }}
            - Failed: ${{ steps.summary.outputs.failed }}
            
            Performance:
            - Success Rate: ${{ steps.summary.outputs.success_rate }}
            - Duration: ${{ steps.summary.outputs.duration }}
            
            ==========================================
            
            View detailed logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Create job summary
        if: always()
        run: |
          echo "## ðŸ“Š Course Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.sync.outputs.exit_code }}" == "0" ]; then
            echo "### âœ… Status: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“ˆ Catalog Status" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Courses | ${{ steps.summary.outputs.api_courses }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HubDB Before Sync | ${{ steps.summary.outputs.hubdb_before }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HubDB After Sync | ${{ steps.summary.outputs.hubdb_after }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ”„ Operations" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Created | ${{ steps.summary.outputs.created }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Updated | ${{ steps.summary.outputs.updated }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deleted | ${{ steps.summary.outputs.deleted }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.summary.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### âš¡ Performance" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Success Rate | ${{ steps.summary.outputs.success_rate }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${{ steps.summary.outputs.duration }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail job if sync failed
        if: steps.sync.outputs.exit_code != '0'
        run: exit 1

